<!DOCTYPE HTML>
<html>
<head>
<title>Title Test</title>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

 
<link rel="stylesheet" href="css/themes/events-theme.css" /> 
<link rel="stylesheet" href="jquery.mobile/jquery.mobile-1.1.1.min.css" />

<script src="jquery.mobile/jquery-1.7.2.min"></script>
<script src="custom/jQueryMobile/jQuery-mobile-init.js"></script>
<script src="jquery.mobile/jquery.mobile-1.1.1.min.js"></script>
<script type="text/javascript" charset="utf-8" src="cordova-2.0.0.js"></script>


<script type="text/javascript">
 
 	// *******************************************************************************
	// ****************** Start of definition of JavaScript objects ******************
	// *******************************************************************************
	
	
	// **************************************************************************************************
	// ********************************** Event Singleton application ***********************************
	// **************************************************************************************************
	// creation of a singleton object (as advised in mobile javascript mobile development book)
	// One of the ideas is to create a singleton object that will maintain application state.
	// When we add html5 offline support all the caching mechanism will be placed in this object 
	var EventListApp = function () { 
		var list;
		return {
			init : function() {
				list = new Array();
			},
			clear : function(){
				list = [];
			},
			size : function(){
				return list.length;
			},
			addEvent : function(event){
				list.push(event);
			}, 
			findEventsInEventList : function (eventId){
				console.log("findEventsInEventList: " + eventId);
				//This should be replaced by cache mechanisms ... until then :)
				for(i=0;i < list.length; i++){
			  		var event = list[i];
			  		if(event && event.id === eventId) 
			  			return event;
				};
			}
		}
	}(); // for what I read what makes it singleton are these last '()' !?!?? strange .. ah
	
	
	// ********************************************************
	// *************** Javascript Artist object ***************
	// ******************************************************** 
	EventListApp.Artist = function (id, artist){
		this.id = id;
		this.artist = artist;
	}
	// adding methods to Artist Object
	// create method toString    
	EventListApp.Artist.prototype.toString  = function(){
		return '[id:' + this.id + ' ,artist: '+ this.artist + ']';
	}

	// ************************************************************ 
	// ***************** Javascript Location object *************** 
	// ************************************************************
	EventListApp.Location = function ( id,city, country, street, postalCode, latitude, longitude){
		this.id = id;
		this.city = city;
		this.country = country;
		this.street = street;
		this.postalCode = postalCode;
		this.latitude = latitude;
		this.longitude = longitude;
	}
	// adding methods to Location Object
	// create method toString    
	EventListApp.Location.prototype.toString  = function(){
		return '[id:' + this.id + ' ,city: '+ this.city + ' ,country: ' + this.country + ' ,street:' + this.street 
					+ ' ,postalCode:' + this.postalCode +' ,latitude:' + this.latitude +' ,longitude:' + this.longitude + ']';
	}


	// ********************************************************************
	// ********************** Javascript Venue object *********************
	// ********************************************************************
	EventListApp.Venue = function (id,venueName, location, website,phoneNumber, image){
		this.id = id;
		this.venueName = venueName;
		this.location = location;
		this.website = website;
		this.phoneNumber = phoneNumber;
		this.image = image;
	}
	// adding methods to Venue Object
	// create method toString    
	EventListApp.Venue.prototype.toString  = function(){
		return '[id:' + this.id + ' , venueName:' + this.venueName + ' , location: '+ this.location.toString() + ' ,website: ' + this.website 
					+ ' ,phoneNumber:' + this.phoneNumber + ' ,image:' + this.image + ']';
	}
	
	
	// *********************************************************************
	// ********************** Javascript Event object **********************
	// *********************************************************************
	// javascript Event object associated with our global singleton object
	// This object will be the main javascript object for events 	
	EventListApp.Event = function (id, title, startDate, description, image, website, artist, venue){
		this.id = id;
		this.title = title;
		this.startDate = startDate;
		this.description = description;
		this.image = image;
		this.website = website;
		this.artist = artist;
		this.venue = venue;
	};
	
	// adding methods to Event Object
	// create method toString (doing like this is not defined in the global namespace). It belong to the class and aren't created everytime an object is created.   
	EventListApp.Event.prototype.toString  = function(){
		return '[id:' + this.id + ' ,title: '+ this.title + ' ,startDate: ' + this.startDate + ' ,description:' + this.description + 
					' ,image:' + this.image +' ,website:' + this.website +' ,artist:' + this.artist.toString() +' ,venue:' + this.venue.toString() +']';
	}
	

	
	// initialize our application singleton
	EventListApp.init();


	// *************************************************************************
	// ************************ Start of jQuery code ***************************
	// *************************************************************************

	$(function(){
		// try to sinalize in the console some events that are fired --- see 181 pro jquery mobile
		$( "#home" ).live( " pagebeforechange pagebeforeload pagebeforecreate pagecreate", function(e, data){
			console.log("Page events are being fired..." + e +  " "+data);
		});
		
	
		// try to create a splashScreen while a app loads
		setTimeout(hideSplash, 1000);
		function hideSplash() {
		  $.mobile.changePage("#home", "fade");
		}
		
		
		// try to load webService info when byNameSearchPage loads		
		$('#byNameSearchPage').live("pageshow", function(){
			// callback funtion invocation
		   init('http://localhost:8080/EventServiceApp/resources/events/city');
		});
			
		// try to load webService info when byLocationSearchPage loads
		$('#byLocationSearchPage').live("pageshow", function(){
			loadCitiesAjax();
		});

	});
	

	// ********************************************************************************
	// ************************ Start of JavaScript functions *************************
	// ********************************************************************************
	
	
	// Refresh function called whenever the user clicks on refresh button on searchByLocation page
	// It should be refactored to be more generic (other pages call it too) or we should create other methods for the other pages  
	function refresh(){
		$("#console").html("Verifying...");
		loadCitiesAjax();
	}


	
	// utility function that loads cities with events and the number of events per city updating the GUI layer then
	// It is called by refresh function()
	function loadCitiesAjax(){
	   // callback function invocation
	   $("#console").html("Downloading ws data...");
	   
	   // url for invoking ws
	   var url = 'http://localhost:8080/EventServiceApp/resources/events/location/dto';
	
	   // obtain ws info city -> nbrEvents	
	   $.getJSON(url, function (json) {
	       	//alert(json);
	        alert(JSON.stringify(eval(json)));
	   		var html = '';
	   		// for each record
	   		$.each(json, function (i, item) {
	   	    
	       		//html += '<li data-role="list-divider" data-theme="c"><a href="#">' + item.country + '</a> </li>';
	       		html += '<li id="' + item.cityId+'"><a href="#eventsByCityPage">' + item.city + '<span class=ui-li-count>' + item.nbrEvents + '</span> </a> </li>';
	       
	  		});
	  		console.log(html);
	  		$("#locationSearchList").html(html);
	  		$("#locationSearchList").listview('refresh');
	  		$("#console").html("Data refreshed ..");  
		}); 
		
		// create a event listener for click events  on (#locationSearchList > li ... every li inside locationSearchList)
		// the idea is to try to associate a click event in a way that we create dinamically the next page (events by city page)
	    $("#locationSearchList").on("click", "li", function() {
	    	// fetch the id of li (it was fulfilled with item.cityId )
		    var id = $(this).attr('id');
		    // fetch the text of li --> to display in the header of next page
		    var city = $(this).text();
		    // create ws url based on the city id clicked
		    var urlByCity = 'http://localhost:8080/EventServiceApp/resources/events/location/' + id;
		    // invoke function to create/fulfill new page results
		    loadEventsByCitiesAjax(urlByCity, city);					
	    });

	}
	
	
	// function for creating events by city page	
	function loadEventsByCitiesAjax(url, city) {
		// obtain page reference
		var $page = $("#eventsByCityPage");
		
		var event;
		
		// get header 
		$header = $page.children( ":jqmData(role=header)" );
		// populate header with the name of the city we are selecting
		$header.find( "h1" ).html( city );
		
		//obtain json info from ws (based on city id)
		$.getJSON(url, function (json) {
			 var html = '';
			 $.each(json, function (i, item) {
			       html += '<li ><a href="javascript:loadEventById('+ item.id +  ')"><img alt="coverArt" src="images/mia.png" /><h3>' + item.title + '</h3>';
			       html += '<p>' + item.startDate + '</p>';
			       html += '<p>' + item.venue.location.city + '</p>';
			       html += '</a></li>';
			       
			       // Create a full Event JavaScript Object based on event object returned by restfull ws
			       event = new EventListApp.Event(item.id, item.title, item.startDate, item.description, item.image, item.website, 
			       								  new EventListApp.Artist(item.artists.id, item.artists.artist),
			       								  new EventListApp.Venue(item.venue.id, 
			       								  						 item.venue.venueName,
			       								  						 new EventListApp.Location(item.venue.location.id,
		       								  						 							   item.venue.location.city,
		       								  						 							   item.venue.location.country,
		       								  						 							   item.venue.location.street,
		       								  						 							   item.venue.location.postalCode,
		       								  						 							   item.venue.location.latitude,
		       								  						 							   item.venue.location.longitude  ),
			       								  						 item.venue.website,
			       								  						 item.venue.phoneNumber,
			       								  						 item.venue.image));
			       console.log(event.toString());
			       EventListApp.addEvent(event);
			  });
			  console.log(html);
			  $("#eventsByCitySearchList").html(html);
			  $("#eventsByCitySearchList").listview('refresh');  
		});
		
		
	}
	
	
		// utility function that loads event information whenever the user chooses and event - updates the GUI layer then
	function loadEventById(eventId){
		// looks in the singleton object for the event clicked/choosed
		var event = EventListApp.findEventsInEventList(eventId);
		// call function to update GUI with event details
		populateEventPage(event);
	} 

	// This function is used to populate eventDetails page with event information
	// It is called by loadEventById function()
	function populateEventPage(event) {
		// fetch eventDetails page
		var $page = $("#eventDetails");
		
		// fetch page header
		$header = $page.children( ":jqmData(role=header)" );
		// find h1 header and fulfill it with event title 
		$header.find( "h1" ).html( event.title );
		
		// fetch page content
		$content = $page.children( ":jqmData(role=content)" );
		
		// Create event info
		var html = '';
		html += '<p><h1><strong> ' + event.description + '</strong></h1></p>'
		html += '<p><strong> ' + event.artist.artist + '</strong></p>'
		html += '<p>' + event.startDate + '</p>'
		html += '<p><a href="'+ event.website + '">'+  event.website +'</a></p>'
		
		
		console.log(html);	
		// we reset the eventInfo from previous chosen events
		$content.find( "#eventInfo" ).empty();
		// append the info from the last event	
		$content.find( "#eventInfo" ).append( html );
		
		
		// create venue info
		html = '';
		html += '<p><h1><strong> ' + event.venue.venueName + '</strong></h1></p>'
		html += '<p>' + event.venue.location.street + ' - ' + event.venue.location.country +'</p>'
		html += '<p>' + event.venue.location.postalCode + ' - ' + event.venue.location.city +'</p>'
		html += '<p> lat: ' + event.venue.location.latitude + 'ยบ</p>'
		html += '<p> long:' + event.venue.location.longitude +'ยบ</p>'
		html += '<p><a href="'+ event.venue.website + '">'+  event.venue.website +'</a></p>'
		
		// we reset the venueInfo from previous chosen events
		$content.find( "#venueInfo" ).empty();
		// append the info from the last event venue
		$content.find( "#venueInfo" ).append( html );

		var tel = 'tel:' + event.venue.phoneNumber; 
		$( "#phoneCallButton" ).attr('href', tel);
		
		// We change to the details page
		$.mobile.changePage($("#eventDetails"));
	}
	
	
		
	// callback function (populates one <li> with the info returned by the webService) 
	// this function will be refactored in some other best way 
	// It was only for testing approaches 
	function init(ws){
		console.log("init");
		$.ajax( {
			type:'get',
			url:ws,
			cache:false,
			datatype:'json',
		   //async: false,
			success:function(data) {
				console.log(data);
				var lang = '';
				$.each(data, function() {
					lang += this['title'] + + "<br/>";
				});
		      	console.log(lang);
				$("#searchEventsList").append('<li><a href="' + "#" + '">' +JSON.stringify(eval(data)) + '</a></li>');
			    $("#searchEventsList").listview('refresh');
			},
			error: function(request,error)  {
				console.log(arguments);
				console.log("error: "  + error);
				$("#searchEventsList").append('<li><a href="' + "#" + '">' +error + '</a></li>');
			    $("#searchEventsList").listview('refresh'); 
			}
		});
	}
	
	
	// ********************************************************************************
	// ********************************************************************************	

</script>

<style type="text/css">

	.splash { 
		align:center;
		background-color: #fff;
		padding: 1000px;
	}
	
	
	/* Navbar text */
	[data-role=navbar] .ui-btn-text {
		font-size: smaller;
	}
	
	.logo {
		margin-top: none;
		display: block;
    	margin-left: auto;
    	margin-right: auto;
	}
	
	.smallLogo {
		margin-bottom: 20px;
	}
	
	[data-role="header"] > h1, .headerMsg {
		color: rgb(119, 149, 252);
		text-align: center;
	}

	.msg{
		margin:0px;
		padding:0px;
	}
	
	#splash {
		background-image: url("images/calendar_128x128.png");
		background-position: center;
		background-attachment: fixed;
		background-repeat: no-repeat;
		text-align: center;
	}
	

	
	
	#eventDetails div[data-role=content]  h1, #eventDetails div[data-role=content]  h2 {
		margin: 0px auto 5px auto;
		font-size: 18px;
	}

	#eventDetails div[data-role=content]  img{
		margin: 0px auto 5px auto;
		font-size: 18px;
	}
	
	#eventDetails div[data-role=content]  p {
		margin: 0px auto 5px auto;
		padding-left: 5px;
	}

	#eventInfo , #venueInfo {
		font-size:12px;
	}


	#contact_buttons a{
		color:rgb(63, 41, 39);
	}
	
	#event_info .header{
		font-weight: bold;
	}
	#event_info .detail{
		font-style: italic;
	}



</style>

</head>

<body>
	
	
	<!-- Splash Screen -->
	<div id="splash" data-role="page" data-theme="a" > 
		<div data-role="content" class="logo" >    	
			<p>	<h2>Welcome to events application!</h2> </p>
				<p class="msg">
					This is a sample application for searching events...
				</p>
		</div>
	</div>


	<!-- Home Page -->
	<div data-role="page" id="home" data-theme="c">
		<div data-role="header">			
			<h1>Events</h1>
			<a href="#settings" data-icon="gear" class="ui-btn-right">Settings</a>
		</div>

		<div data-role="content" >
			<img alt="Events" src="images/calendar_100x100.png" class="logo">
			<div class="headerMsg" >		
				<p>	<h4>Simple apps to search for fun !!!</h4> </p>
			</div>

			<ul data-role="listview" >
				<!-- <li data-role="list-divider" data-theme="c">Event application</li> --> 
				<li data-icon="false"> <a href="#loginPage" ><img alt="Log in" src="images/login.png" class="ui-li-icon">Log In</a></li>
				<li data-icon="false"> <a href="#byLocationSearchPage" ><img alt="Events" src="images/_search.png" class="ui-li-icon">Events</a></li>
				<li data-icon="false"> <a href="#genreSearchPage" ><img alt="Sign Up" src="images/add_user.png" class="ui-li-icon">Sign Up</a></li>
				<li data-icon="false"> <a href="#eventDetails" ><img alt="About" src="images/about.png" class="ui-li-icon">About</a></li>
				<li data-icon="false"> <a href="feedback.html" data-rel="dialog"><img alt="Feedback" src="images/feedback.png" class="ui-li-icon">Feedback</a></li>
			</ul>
		</div>
		
		<div data-role="footer" data-position="fixed">
			<h5>@Mobile Applications</h5>
		</div>
	</div>

	
	
	
	<!-- Genre Search Page -->
	<div data-role="page" id="byLocationSearchPage"  data-add-back-btn="true">
		<div data-role="header">
			<h1>Events</h1>
			<a href='javascript:refresh();' data-icon="refresh" id="refresh" 
					class="ui-btn-right" data-iconpos="notext"></a>
		</div>

		<div data-role="content">
			<h2><p id="console"></p></h2>
			<ul id="locationSearchList" data-role="listview" data-filter="true" data-filter-placeholder="Search locations ...">

			</ul>
		</div>

		<div data-role="footer" data-position="fixed">
			<div data-role=navbar>
				<ul>
					<li><a href="#home" data-icon="info">Home</a></li>	
					<li><a href="#" class="ui-btn-active"  data-icon="grid">Location</a></li>
					<li><a href="#byNameSearchPage" data-icon="Name">Name</a></li>
					<li><a href="#" data-icon="info">Nearby</a></li>
					<li><a href="#" data-icon="star">Today</a></li>
				</ul> 
			</div>
		</div>
	</div>


	<!-- Genre Search Page -->
	<div data-role="page" id="eventsByCityPage"  data-add-back-btn="true">
		<div data-role="header">
			<h1></h1>
			<a href="#settings" data-icon="gear" class="ui-btn-right">Settings</a>
		</div>

		<div data-role="content">
			<ul id="eventsByCitySearchList" data-role="listview" data-filter="true" data-filter-placeholder="Search events ...">

			</ul>
		</div>

		<div data-role="footer" data-position="fixed">
			<div data-role=navbar>
				<ul>
					<li><a href="#home" data-icon="home">Home</a></li>	
					<li><a href="#" data-icon="grid">Location</a></li>
					<li><a href="#byNameSearchPage" data-icon="Name">Name</a></li>
					<li><a href="#" data-icon="info">Nearby</a></li>
					<li><a href="#" data-icon="star">Today</a></li>
				</ul> 
			</div>
		</div>
	</div>


	
	<!-- By Name Search Page -->
	<div data-role="page" id="byNameSearchPage"  data-add-back-btn="true">
		<div data-role="header">
			<h1>Events</h1>
			<a href="#settings" data-icon="gear" class="ui-btn-right">Settings</a>
		</div>

		<div data-role="content" >
			
			
			<ul id="searchEventsList" data-role="listview" data-filter="true" data-filter-placeholder="Search Events ...">
				<li data-role="list-divider">A</li> 
				<li><a href="#">
						<img src="images/mia.png" />
						<h2>An Event from MIA</h2> 
		    			<p>MIA event</p>
		    		</a>
		    	</li>
				<li data-role="list-divider">B</li> 
				<li data-role="list-divider">D</li> 
		    	<li data-role="list-divider">E</li> 
				<li>
					<a href="#">
						<img src="images/events.png" />
						<h3>Event Item title</h3> 
		    			<p>Event Item overview 2</p>
		    		</a>
		    	</li>
				<li data-role="list-divider">F</li> 
				<li data-role="list-divider">G</li> 
		    	<li data-role="list-divider">H</li> 
			</ul>
		</div>

		<div data-role="footer" data-position="fixed">
			<div data-role=navbar>
			<ul>
		        <li><a href="#home" data-icon="home">Home</a></li>	
				<li><a href="#byLocationSearchPage" data-icon="grid">Location</a></li>
				<li><a href="#byNameSearchPage" class="ui-btn-active" data-icon="Name">Name</a></li>
				<li><a href="#" data-icon="home">Nearby</a></li>
				<li><a href="#" data-icon="star">Today</a></li>
      		</ul> 
	    </div>
		</div>

	</div>



	<div data-role="page" id="settings" data-add-back-btn="true">
		<div data-role="header">
			<h1>Events</h1>
			<a href="#settings" data-icon="gear" class="ui-btn-right">Settings</a>
		</div>

		<div data-role="content">
			<p>Settings</p>
			<label for="updated">Receive updates</label> <select id="updated"
				name="updated" data-role="slider">
				<option value="no">No</option>
				<option value="yes">Yes</option>
			</select>
		</div>

	</div>

	<div data-role="dialog" id="loginPage" data-add-back-btn="true">

		<div data-role="header">
			<h1>Events</h1>
		</div>

		<div data-role="content">
			<h1>Login</h1>
			
			<form action="" method="post" data-transition="none">

			   <div data-role="fieldcontain">
				 <label for="user">User:</label>
				 <input type="text" name="user" id="user" value="" required="true" />
			   </div>

			   <div data-role="fieldcontain">
				 <label for="password">Password:</label>
				 <input type="password" name="password" id="password" value="" required="true" />
			   </div>
			   
			   
			   <input type="submit" value="Login" data-theme="a">
			   <a href="#home" data-role="button">Cancel</a>
			 
			 </form>
		</div>

		<div data-role="footer">
			<h4>@Mobile Applications</h4>
		</div>


	</div>

	<div id="eventDetails" data-role="page" data-add-back-btn="true">

		<div data-role="header">
			<h1> </h1>
		</div> 
	
		<div data-role="content">
			<div class="ui-grid-a" id="event_info">
				<div id="eventInfo" class="ui-block-a">

				</div>
				<div class="ui-block-b">
					<p><img src="images/mia_.png" alt="photo"/></p>
				</div>
			</div><!-- /grid-a -->
			<hr/>
	
			<div class="ui-grid-a" >
				<div id="venueInfo" class="ui-block-a" >
					
				</div>
				<div class="ui-block-b">
					<img src="images/maps_small.png" alt="maps"/>
			    </div>
			</div><!-- /grid-a -->
			<div id="contact_buttons">
				<a href="http://maps.google.com/maps?hl=en&safe=off&q=braga+ferreiros+google+maps&ie=UTF-8&hq=&hnear=0xd24fed6130e97f5:0x7dcd16ff52948be6,Ferreiros,+Portugal&ei=jAhbUKnaEoOGrAfho4DQCQ&ved=0CCAQ8gEwAA"  data-role="button" data-icon="maps"> Find in Google Maps </a>
				<a id="phoneCallButton" href="tel:0388161072"  data-role="button" data-icon="tel"> Call </a>
			</div>
		</div>
	
	</div><!-- /page -->


</body>
</html>